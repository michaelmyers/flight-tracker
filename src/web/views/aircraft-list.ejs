<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FLIGHT TRACKER // <%= area.name.toUpperCase() %></title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/public/css/retro-crt.css">
</head>
<body>
  <div class="crt-container">
    <div class="connection-status connected" id="connection-status">
      <div class="status-indicator"></div>
      <span>LIVE</span>
    </div>

    <div class="screen-border">
      <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
        <h1>ZONE: <%= area.name.toUpperCase() %></h1>
        <div class="subtitle">AIRCRAFT MONITORING</div>
      </div>

      <div class="status-bar">
        <div class="status-item">
          <div class="status-indicator"></div>
          <span>TRACKING ACTIVE</span>
        </div>
        <div class="status-item">
          <span>IN ZONE: <span id="current-count"><%= currentAircraft.length %></span></span>
        </div>
        <div class="status-item">
          <span>RECENT: <span id="recent-count"><%= recentAircraft.length %></span></span>
        </div>
        <div class="status-item">
          <span>RANGE: <%= timeRange %> <%= timeRange === 1 ? 'HOUR' : 'HOURS' %></span>
        </div>
        <div class="status-item">
          <span id="current-time">--:--:--</span>
        </div>
      </div>

      <!-- Main Content Container -->
      <div style="display: flex; gap: 20px; margin-top: 20px;">
        <!-- Radar View (Left) -->
        <div class="radar-section" style="flex: 0 0 500px;">
          <h3 style="color: var(--green-bright); margin-bottom: 15px; font-size: 20px; border-bottom: 1px solid var(--green-dark); padding-bottom: 10px;">
            RADAR VIEW
          </h3>
          <div class="radar-canvas-wrapper" style="position: relative;">
            <canvas id="mini-radar-canvas" width="500" height="500" style="width: 100%; height: auto; border: 1px solid var(--green-medium); background: rgba(0, 0, 0, 0.95); cursor: crosshair;"></canvas>
            <div class="radar-info" style="position: absolute; top: 10px; left: 10px; color: var(--green-bright); font-size: 12px; background: rgba(0, 0, 0, 0.8); padding: 5px;">
              <div>RANGE: <span id="radar-range">5</span> MI</div>
              <div>TARGETS: <span id="radar-targets">0</span></div>
            </div>
          </div>

          <!-- Selected Aircraft Info Panel -->
          <div id="selected-aircraft-info" style="margin-top: 15px; padding: 10px; border: 1px solid var(--green-dark); background: rgba(0, 255, 0, 0.02); display: none;">
            <h4 style="color: var(--green-bright); margin-bottom: 10px; font-size: 16px;">SELECTED TARGET</h4>
            <div id="selected-info-content" style="color: var(--green-medium); font-size: 14px; line-height: 1.6;">
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Aircraft List (Right) -->
        <div style="flex: 1; min-width: 0;">

          <!-- Active Aircraft Section (Flying with ADS-B data) -->
          <% if (typeof activeAircraft !== 'undefined' && activeAircraft && activeAircraft.length > 0) { %>
          <div style="margin-bottom: 30px;">
            <h3 style="color: var(--green-bright); margin-bottom: 15px; font-size: 20px; border-bottom: 1px solid var(--green-dark); padding-bottom: 10px;">
              ACTIVE AIRCRAFT IN ZONE (<%= activeAircraft.length %>)
            </h3>
            <div id="active-aircraft-container" class="aircraft-grid">
                <% activeAircraft.forEach(ac => { %>
                  <div class="aircraft-item active-aircraft" data-icao24="<%= ac.icao24 %>" style="border-color: var(--green-bright); background: rgba(0, 255, 0, 0.05);">
                    <div class="aircraft-id">
                      <%= ac.icao24.toUpperCase() %>
                      <% if (ac.callsign) { %>
                        <div style="font-size: 16px; color: var(--green-medium); margin-top: 5px;">
                          <%= ac.callsign %>
                        </div>
                      <% } %>
                    </div>

                    <div class="aircraft-details">
                      <div class="detail-row">
                        <span class="detail-label">ALT:</span>
                        <span class="detail-value"><%= ac.altitude ? ac.altitude.toLocaleString() : '--' %> ft</span>
                        <span class="detail-label">SPD:</span>
                        <span class="detail-value"><%= ac.speed !== null && ac.speed !== undefined ? Math.round(ac.speed) : '--' %> kts</span>
                        <span class="detail-label">HDG:</span>
                        <span class="detail-value"><%= ac.track !== null && ac.track !== undefined ? Math.round(ac.track) + 'Â°' : '--' %></span>
                      </div>
                      <% if (ac.manufacturer || ac.model) { %>
                        <div class="detail-row">
                          <span class="detail-label">TYPE:</span>
                          <span class="detail-value">
                            <%= [ac.manufacturer, ac.model].filter(Boolean).join(' ') || 'UNKNOWN' %>
                          </span>
                        </div>
                      <% } %>
                      <% if (ac.operator) { %>
                        <div class="detail-row">
                          <span class="detail-label">OPER:</span>
                          <span class="detail-value"><%= ac.operator %></span>
                        </div>
                      <% } %>
                    </div>

                    <div class="aircraft-time">
                      <div style="color: var(--green-medium);">ENTERED: <%= new Date(ac.enteredAt).toTimeString().split(' ')[0] %></div>
                    </div>
                  </div>
                <% }) %>
            </div>
          </div>
          <% } %>

          <!-- Landed Aircraft Section (In zone but on ground) -->
          <% if (typeof landedAircraft !== 'undefined' && landedAircraft && landedAircraft.length > 0) { %>
            <div style="margin-bottom: 30px;">
              <h3 style="color: var(--green-medium); margin-bottom: 15px; font-size: 20px; border-bottom: 1px solid var(--green-dark); padding-bottom: 10px;">
                LANDED AIRCRAFT IN ZONE (<%= landedAircraft.length %>)
              </h3>
              <div id="landed-aircraft-container" class="aircraft-grid">
                <% landedAircraft.forEach(ac => { %>
                  <div class="aircraft-item landed-aircraft" data-icao24="<%= ac.icao24 %>" style="opacity: 0.7;">
                    <div class="aircraft-id">
                      <%= ac.icao24.toUpperCase() %>
                      <% if (ac.callsign) { %>
                        <div style="font-size: 16px; color: var(--green-dark); margin-top: 5px;">
                          <%= ac.callsign %>
                        </div>
                      <% } %>
                    </div>

                    <div class="aircraft-details">
                      <div class="detail-row">
                        <span class="detail-label">ALT:</span>
                        <span class="detail-value"><%= ac.altitude !== null && ac.altitude !== undefined ? ac.altitude : 'GND' %> ft</span>
                        <span class="detail-label">SPD:</span>
                        <span class="detail-value"><%= ac.speed !== null && ac.speed !== undefined ? Math.round(ac.speed) : '0' %> kts</span>
                        <span class="detail-label">STATUS:</span>
                        <span class="detail-value" style="color: var(--green-dark);">ON GROUND</span>
                      </div>
                      <% if (ac.manufacturer || ac.model) { %>
                        <div class="detail-row">
                          <span class="detail-label">TYPE:</span>
                          <span class="detail-value">
                            <%= [ac.manufacturer, ac.model].filter(Boolean).join(' ') || 'UNKNOWN' %>
                          </span>
                        </div>
                      <% } %>
                      <% if (ac.operator) { %>
                        <div class="detail-row">
                          <span class="detail-label">OPER:</span>
                          <span class="detail-value"><%= ac.operator %></span>
                        </div>
                      <% } %>
                    </div>

                    <div class="aircraft-time">
                      <div style="color: var(--green-dark);">LANDED: <%= new Date(ac.enteredAt).toTimeString().split(' ')[0] %></div>
                    </div>
                  </div>
                <% }) %>
              </div>
            </div>
          <% } %>

          <!-- Current Aircraft Section (for backward compatibility, hidden if new sections are shown) -->
          <% if ((typeof activeAircraft === 'undefined' || !activeAircraft) && currentAircraft && currentAircraft.length > 0) { %>
            <div style="margin-bottom: 30px;">
              <h3 style="color: var(--green-bright); margin-bottom: 15px; font-size: 24px; border-bottom: 1px solid var(--green-dark); padding-bottom: 10px;">
                CURRENT AIRCRAFT IN ZONE
              </h3>
          <div id="current-aircraft-container" class="aircraft-grid">
            <% currentAircraft.forEach(ac => { %>
              <div class="aircraft-item current-aircraft" data-icao24="<%= ac.icao24 %>">
                <div class="aircraft-id">
                  <%= ac.icao24.toUpperCase() %>
                  <% if (ac.callsign) { %>
                    <div style="font-size: 16px; color: var(--green-dim); margin-top: 5px;">
                      <%= ac.callsign %>
                    </div>
                  <% } %>
                </div>

                <div class="aircraft-details">
                  <div class="detail-row">
                    <span class="detail-label">ALT:</span>
                    <span class="detail-value"><%= ac.altitude || '--' %> ft</span>
                    <span class="detail-label">SPD:</span>
                    <span class="detail-value"><%= ac.speed ? Math.round(ac.speed) : '--' %> kts</span>
                    <span class="detail-label">HDG:</span>
                    <span class="detail-value"><%= ac.track ? Math.round(ac.track) + 'Â°' : '--' %></span>
                  </div>
                  <% if (ac.manufacturer || ac.model) { %>
                    <div class="detail-row">
                      <span class="detail-label">TYPE:</span>
                      <span class="detail-value">
                        <%= [ac.manufacturer, ac.model].filter(Boolean).join(' ') || 'UNKNOWN' %>
                      </span>
                    </div>
                  <% } %>
                  <% if (ac.operator) { %>
                    <div class="detail-row">
                      <span class="detail-label">OPER:</span>
                      <span class="detail-value"><%= ac.operator %></span>
                    </div>
                  <% } %>
                </div>

                <div class="aircraft-time">
                  <div>ENTERED: <%= new Date(ac.enteredAt).toTimeString().split(' ')[0] %></div>
                  <div style="color: var(--green-bright);">IN ZONE</div>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      <% } %>

          <!-- Exited Aircraft Section -->
          <% if (recentAircraft && recentAircraft.length > 0) { %>
        <div style="margin-bottom: 30px;">
          <h3 style="color: var(--green-dim); margin-bottom: 15px; font-size: 20px; border-bottom: 1px solid var(--green-dark); padding-bottom: 10px;">
            EXITED AIRCRAFT (<%= recentAircraft.length %>)
          </h3>
          <div id="recent-aircraft-container" class="aircraft-grid">
            <% recentAircraft.forEach(ac => { %>
              <div class="aircraft-item recent-aircraft" data-icao24="<%= ac.icao24 %>" style="opacity: 0.7;">
                <div class="aircraft-id">
                  <%= ac.icao24.toUpperCase() %>
                  <% if (ac.callsign) { %>
                    <div style="font-size: 16px; color: var(--green-dim); margin-top: 5px;">
                      <%= ac.callsign %>
                    </div>
                  <% } %>
                </div>

                <div class="aircraft-details">
                  <div class="detail-row">
                    <span class="detail-label">ALT:</span>
                    <span class="detail-value"><%= ac.altitude || '--' %> ft</span>
                    <span class="detail-label">SPD:</span>
                    <span class="detail-value"><%= ac.speed ? Math.round(ac.speed) : '--' %> kts</span>
                    <span class="detail-label">HDG:</span>
                    <span class="detail-value"><%= ac.track ? Math.round(ac.track) + 'Â°' : '--' %></span>
                  </div>
                  <% if (ac.manufacturer || ac.model) { %>
                    <div class="detail-row">
                      <span class="detail-label">TYPE:</span>
                      <span class="detail-value">
                        <%= [ac.manufacturer, ac.model].filter(Boolean).join(' ') || 'UNKNOWN' %>
                      </span>
                    </div>
                  <% } %>
                  <% if (ac.operator) { %>
                    <div class="detail-row">
                      <span class="detail-label">OPER:</span>
                      <span class="detail-value"><%= ac.operator %></span>
                    </div>
                  <% } %>
                </div>

                <div class="aircraft-time">
                  <div>ENTERED: <%= new Date(ac.enteredAt).toTimeString().split(' ')[0] %></div>
                  <div style="color: #ff6666;">EXITED: <%= new Date(ac.exitedAt).toTimeString().split(' ')[0] %></div>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      <% } %>

          <!-- No Data Message -->
          <% if ((!currentAircraft || currentAircraft.length === 0) && (!recentAircraft || recentAircraft.length === 0)) { %>
            <div class="no-data">NO AIRCRAFT ACTIVITY IN LAST <%= timeRange %> <%= timeRange === 1 ? 'HOUR' : 'HOURS' %></div>
          <% } %>

          <div id="loading" class="loading" style="display: none;">
            UPDATING...
          </div>
        </div>
      </div>

      <!-- Navigation Buttons at Bottom -->
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--green-dark); display: flex; gap: 10px;">
        <a href="/" class="button">&lt; BACK TO ZONES</a>
        <a href="/radar" class="button">ANTENNA RADAR</a>
      </div>
    </div>
  </div>

  <script src="/public/js/aircraft-tracker.js"></script>
  <script>
    const areaId = <%= area.id %>;
    const timeRange = <%= timeRange %>;
    const areaPolygon = <%- JSON.stringify(JSON.parse(area.polygon)) %>;
    const areaName = '<%= area.name %>';

    initializeTracker(areaId, timeRange);

    // Mini Radar Implementation
    class MiniRadar {
      constructor() {
        this.canvas = document.getElementById('mini-radar-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.centerX = 250;
        this.centerY = 250;
        this.radius = 200;
        this.aircraft = new Map();
        this.zoneCenter = this.calculateZoneCenter();
        this.range = this.calculateOptimalRange(); // Calculate range to fit zone
        this.pixelsPerMile = this.radius / this.range;
        this.selectedAircraft = null;

        this.setupEventListeners();
        this.setupWebSocket();
        this.draw();
        setInterval(() => this.draw(), 1000);

        // Update range display
        document.getElementById('radar-range').textContent = this.range.toFixed(1);
      }

      setupEventListeners() {
        this.canvas.addEventListener('click', (e) => {
          const rect = this.canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          this.handleRadarClick(x, y);
        });
      }

      handleRadarClick(x, y) {
        // Find closest aircraft to click
        let closestAircraft = null;
        let closestDistance = 15; // Max click distance in pixels

        this.aircraft.forEach((ac, hex) => {
          const point = this.latLonToRadar(ac.lat, ac.lon);
          const distance = Math.sqrt(Math.pow(x - point.x, 2) + Math.pow(y - point.y, 2));

          if (distance < closestDistance) {
            closestDistance = distance;
            closestAircraft = ac;
          }
        });

        if (closestAircraft) {
          this.selectAircraft(closestAircraft);
        } else {
          this.clearSelection();
        }
      }

      selectAircraft(aircraft) {
        this.selectedAircraft = aircraft;
        this.draw(); // Redraw to show floating label
      }

      clearSelection() {
        this.selectedAircraft = null;
        this.draw(); // Redraw to remove label
      }

      updateInfoPanel(aircraft) {
        const infoPanel = document.getElementById('selected-aircraft-info');
        const content = document.getElementById('selected-info-content');

        if (!aircraft) {
          infoPanel.style.display = 'none';
          return;
        }

        content.innerHTML = `
          <div><strong>ICAO:</strong> ${aircraft.hex || 'N/A'}</div>
          <div><strong>CALLSIGN:</strong> ${aircraft.callsign || 'N/A'}</div>
          <div><strong>ALTITUDE:</strong> ${aircraft.altitude ? aircraft.altitude.toLocaleString() + ' ft' : 'N/A'}</div>
          <div><strong>SPEED:</strong> ${aircraft.speed !== null && aircraft.speed !== undefined ? Math.round(aircraft.speed) + ' kts' : 'N/A'}</div>
          <div><strong>HEADING:</strong> ${aircraft.track !== null && aircraft.track !== undefined ? Math.round(aircraft.track) + 'Â°' : 'N/A'}</div>
          <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--green-dark);">
            <strong>STATUS:</strong> <span style="color: ${aircraft.inZone ? 'var(--green-bright)' : 'var(--green-medium)'};">${aircraft.inZone ? 'IN ZONE' : 'NEARBY'}</span>
          </div>
        `;

        infoPanel.style.display = 'block';
      }

      calculateZoneCenter() {
        if (!areaPolygon || areaPolygon.length === 0) {
          return { lat: 38.9072, lon: -77.0369 }; // Default to antenna location
        }

        let sumLat = 0, sumLon = 0;
        areaPolygon.forEach(coord => {
          sumLat += coord[0];
          sumLon += coord[1];
        });

        return {
          lat: sumLat / areaPolygon.length,
          lon: sumLon / areaPolygon.length
        };
      }

      calculateOptimalRange() {
        if (!areaPolygon || areaPolygon.length === 0) {
          return 5; // Default 5 mile range
        }

        let maxDistance = 0;
        const center = this.zoneCenter;

        // Find the furthest point from center
        areaPolygon.forEach(coord => {
          const latDiff = coord[0] - center.lat;
          const lonDiff = coord[1] - center.lon;

          // Convert to miles
          const milesLat = latDiff * 69;
          const milesLon = lonDiff * 69 * Math.cos(center.lat * Math.PI / 180);

          const distance = Math.sqrt(milesLat * milesLat + milesLon * milesLon);
          if (distance > maxDistance) {
            maxDistance = distance;
          }
        });

        // Add 20% padding to ensure entire zone is visible
        const optimalRange = Math.ceil(maxDistance * 1.2);

        // Minimum 2 miles, maximum 20 miles
        return Math.min(Math.max(optimalRange, 2), 20);
      }

      setupWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}`);

        ws.onopen = () => {
          ws.send(JSON.stringify({
            type: 'SUBSCRIBE_AIRCRAFT',
            sessionId: 'area-' + areaId
          }));
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'AIRCRAFT_UPDATE' && data.aircraft) {
              this.updateAircraft(data.aircraft);
            }
          } catch (e) {
            // Ignore non-JSON messages
          }
        };

        ws.onerror = (error) => {
          console.error('Mini radar WebSocket error:', error);
        };

        ws.onclose = () => {
          // Try to reconnect after 5 seconds
          setTimeout(() => this.setupWebSocket(), 5000);
        };
      }

      updateAircraft(aircraftList) {
        this.aircraft.clear();
        const maxDistanceMiles = this.range * 1.1; // Show aircraft within 110% of range

        aircraftList.forEach(ac => {
          if (ac.lat && ac.lon) {
            // Calculate distance from zone center
            const latDiff = ac.lat - this.zoneCenter.lat;
            const lonDiff = ac.lon - this.zoneCenter.lon;
            const milesLat = latDiff * 69;
            const milesLon = lonDiff * 69 * Math.cos(this.zoneCenter.lat * Math.PI / 180);
            const distance = Math.sqrt(milesLat * milesLat + milesLon * milesLon);

            // Only add aircraft within range
            if (distance <= maxDistanceMiles) {
              this.aircraft.set(ac.hex, {
                hex: ac.hex,
                lat: ac.lat,
                lon: ac.lon,
                altitude: ac.altitude,
                track: ac.track || 0,
                callsign: ac.flight,
                speed: ac.gs,
                inZone: this.isInZone(ac.lat, ac.lon)
              });
            }
          }
        });
        document.getElementById('radar-targets').textContent = this.aircraft.size;

        // Update info panel if selected aircraft data changed
        if (this.selectedAircraft) {
          const updated = this.aircraft.get(this.selectedAircraft.hex);
          if (updated) {
            this.selectedAircraft = updated;
            this.updateInfoPanel(updated);
          } else {
            this.clearSelection();
          }
        }
      }

      isInZone(lat, lon) {
        if (!areaPolygon || areaPolygon.length < 3) return false;

        let inside = false;
        for (let i = 0, j = areaPolygon.length - 1; i < areaPolygon.length; j = i++) {
          const xi = areaPolygon[i][0], yi = areaPolygon[i][1];
          const xj = areaPolygon[j][0], yj = areaPolygon[j][1];

          const intersect = ((yi > lon) !== (yj > lon)) &&
                          (lat < (xj - xi) * (lon - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      }

      latLonToRadar(lat, lon) {
        const latDiff = lat - this.zoneCenter.lat;
        const lonDiff = lon - this.zoneCenter.lon;

        // Approximate conversion (1 degree latitude ~ 69 miles, adjust longitude by latitude)
        const milesLat = latDiff * 69;
        const milesLon = lonDiff * 69 * Math.cos(this.zoneCenter.lat * Math.PI / 180);

        const x = this.centerX + (milesLon * this.pixelsPerMile);
        const y = this.centerY - (milesLat * this.pixelsPerMile);

        return { x, y };
      }

      draw() {
        // Clear canvas
        this.ctx.clearRect(0, 0, 500, 500);

        // Draw radar background
        this.ctx.fillStyle = 'rgba(0, 0, 0, 0.95)';
        this.ctx.fillRect(0, 0, 500, 500);

        // Draw range rings
        this.ctx.strokeStyle = 'rgba(0, 255, 0, 0.2)';
        this.ctx.lineWidth = 1;
        for (let i = 1; i <= 4; i++) {
          this.ctx.beginPath();
          this.ctx.arc(this.centerX, this.centerY, (this.radius / 4) * i, 0, 2 * Math.PI);
          this.ctx.stroke();
        }

        // Draw cross hairs
        this.ctx.beginPath();
        this.ctx.moveTo(this.centerX - this.radius, this.centerY);
        this.ctx.lineTo(this.centerX + this.radius, this.centerY);
        this.ctx.moveTo(this.centerX, this.centerY - this.radius);
        this.ctx.lineTo(this.centerX, this.centerY + this.radius);
        this.ctx.stroke();

        // Draw zone polygon
        if (areaPolygon && areaPolygon.length > 2) {
          this.ctx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
          this.ctx.lineWidth = 2;
          this.ctx.beginPath();

          areaPolygon.forEach((coord, i) => {
            const point = this.latLonToRadar(coord[0], coord[1]);
            if (i === 0) {
              this.ctx.moveTo(point.x, point.y);
            } else {
              this.ctx.lineTo(point.x, point.y);
            }
          });

          this.ctx.closePath();
          this.ctx.stroke();

          // Fill zone with slight transparency
          this.ctx.fillStyle = 'rgba(0, 255, 0, 0.05)';
          this.ctx.fill();
        }

        // Draw center point
        this.ctx.fillStyle = '#00ff00';
        this.ctx.beginPath();
        this.ctx.arc(this.centerX, this.centerY, 3, 0, 2 * Math.PI);
        this.ctx.fill();

        // Draw aircraft
        this.aircraft.forEach((ac, hex) => {
          const point = this.latLonToRadar(ac.lat, ac.lon);

          // Check if aircraft is within radar display bounds
          const dist = Math.sqrt(Math.pow(point.x - this.centerX, 2) + Math.pow(point.y - this.centerY, 2));
          if (dist <= this.radius) {
            // Check if this is the selected aircraft
            const isSelected = this.selectedAircraft && this.selectedAircraft.hex === ac.hex;

            if (isSelected) {
              // Draw highlight circle for selected aircraft
              this.ctx.strokeStyle = '#00ff00';
              this.ctx.lineWidth = 2;
              this.ctx.beginPath();
              this.ctx.arc(point.x, point.y, 15, 0, 2 * Math.PI);
              this.ctx.stroke();

              // Draw connecting line from center to selected aircraft
              this.ctx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
              this.ctx.lineWidth = 1;
              this.ctx.setLineDash([5, 5]);
              this.ctx.beginPath();
              this.ctx.moveTo(this.centerX, this.centerY);
              this.ctx.lineTo(point.x, point.y);
              this.ctx.stroke();
              this.ctx.setLineDash([]);
            }

            // Color based on selection
            this.ctx.fillStyle = isSelected ? '#00ff00' : 'rgba(0, 255, 0, 0.7)';

            // Draw aircraft icon
            this.ctx.save();
            this.ctx.translate(point.x, point.y);
            this.ctx.rotate((ac.track || 0) * Math.PI / 180);

            // Draw simple aircraft symbol (larger if selected)
            const scale = isSelected ? 1.5 : 1;
            this.ctx.beginPath();
            this.ctx.moveTo(0, -5 * scale);
            this.ctx.lineTo(-3 * scale, 3 * scale);
            this.ctx.lineTo(0, 1 * scale);
            this.ctx.lineTo(3 * scale, 3 * scale);
            this.ctx.closePath();
            this.ctx.fill();

            this.ctx.restore();

            // Draw info label for selected aircraft (floating label like main radar)
            if (isSelected) {
              this.drawInfoLabel(ac);
            }
          }
        });

        // Remove label if no aircraft selected
        if (!this.selectedAircraft) {
          const label = document.getElementById('mini-radar-info-label');
          if (label) label.remove();
        }
      }

      drawInfoLabel(aircraft) {
        // Create or update floating info label
        let label = document.getElementById('mini-radar-info-label');
        if (!label) {
          label = document.createElement('div');
          label.id = 'mini-radar-info-label';
          label.style.position = 'absolute';
          label.style.backgroundColor = 'rgba(0, 0, 0, 0.95)';
          label.style.border = '1px solid #00ff00';
          label.style.padding = '4px 8px';
          label.style.fontSize = '13px';
          label.style.fontFamily = 'VT323, monospace';
          label.style.color = '#00ff00';
          label.style.pointerEvents = 'none';
          label.style.zIndex = '1000';
          label.style.whiteSpace = 'nowrap';
          label.style.boxShadow = '0 0 10px rgba(0, 255, 0, 0.3)';
          this.canvas.parentElement.appendChild(label);
        }

        // Build label content with altitude trend
        const altTrend = this.getAltitudeTrend(aircraft);
        let altSymbol = '';
        let trendClass = '';
        if (altTrend === 'climbing') {
          altSymbol = ' â²';
          trendClass = 'climbing';
        } else if (altTrend === 'descending') {
          altSymbol = ' â¼';
          trendClass = 'descending';
        }

        const callsign = aircraft.callsign || aircraft.hex.toUpperCase();
        const altitude = aircraft.altitude ? `${aircraft.altitude.toLocaleString()}ft` : '----ft';
        const speed = aircraft.speed ? `${Math.round(aircraft.speed)}kt` : '---kt';

        // Format label with proper spacing
        label.innerHTML = `
          <div style="display: flex; gap: 12px; align-items: center;">
            <span style="font-weight: bold; color: #00ff00;">${callsign}</span>
            <span style="color: ${altTrend === 'climbing' ? '#00ff00' : altTrend === 'descending' ? '#ffaa00' : '#00ff00'};">
              ${altitude}${altSymbol}
            </span>
            <span>${speed}</span>
          </div>
        `;

        // Position label near aircraft
        const point = this.latLonToRadar(aircraft.lat, aircraft.lon);
        const canvasRect = this.canvas.getBoundingClientRect();
        const containerRect = this.canvas.parentElement.getBoundingClientRect();

        // Calculate position relative to the canvas container
        const offsetX = canvasRect.left - containerRect.left;
        const offsetY = canvasRect.top - containerRect.top;

        // Position label to the right and slightly above the aircraft
        label.style.left = `${point.x + offsetX + 20}px`;
        label.style.top = `${point.y + offsetY - 15}px`;

        // Keep label within bounds
        const labelRect = label.getBoundingClientRect();
        const containerBounds = containerRect;

        // Adjust if label goes off right edge
        if (labelRect.right > containerBounds.right) {
          label.style.left = `${point.x + offsetX - labelRect.width - 20}px`;
        }

        // Adjust if label goes off top
        if (labelRect.top < containerBounds.top) {
          label.style.top = `${point.y + offsetY + 15}px`;
        }
      }

      getAltitudeTrend(aircraft) {
        // Track altitude history for trend detection
        if (!this.altitudeHistory) this.altitudeHistory = new Map();

        const history = this.altitudeHistory.get(aircraft.hex);
        const currentAlt = aircraft.altitude || 0;

        if (!history || !history.length) {
          // Initialize history
          this.altitudeHistory.set(aircraft.hex, [{
            altitude: currentAlt,
            time: Date.now()
          }]);
          return 'level';
        }

        // Add current reading to history
        const now = Date.now();
        history.push({ altitude: currentAlt, time: now });

        // Keep only last 5 readings
        if (history.length > 5) {
          history.shift();
        }

        // Need at least 2 readings to determine trend
        if (history.length < 2) return 'level';

        // Calculate rate of change over recent history
        let totalChange = 0;
        let samples = 0;

        for (let i = 1; i < history.length; i++) {
          const timeDiff = (history[i].time - history[i-1].time) / 1000; // seconds
          if (timeDiff > 0) {
            const altChange = history[i].altitude - history[i-1].altitude;
            const ratePerMin = (altChange / timeDiff) * 60;
            totalChange += ratePerMin;
            samples++;
          }
        }

        if (samples === 0) return 'level';

        const avgRatePerMin = totalChange / samples;

        // Thresholds: > 100 ft/min climbing, < -100 ft/min descending
        if (avgRatePerMin > 100) return 'climbing';
        if (avgRatePerMin < -100) return 'descending';
        return 'level';
      }
    }

    // Initialize mini radar when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new MiniRadar();
    });
  </script>
</body>
</html>